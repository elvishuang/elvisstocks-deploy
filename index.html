<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票推薦跑馬燈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
        }
        
        .ticker-container {
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.7);
            position: relative;
        }
        
        .ticker {
            white-space: nowrap;
            animation: ticker 30s linear infinite;
            padding-left: 100%;
        }
        
        @keyframes ticker {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        .stock-item {
            display: inline-block;
            padding: 0 2rem;
            position: relative;
        }
        
        .stock-item:after {
            content: "•";
            position: absolute;
            right: 0;
        }
        
        .up {
            color: #4ade80;
        }
        
        .down {
            color: #f87171;
        }
        
        .neutral {
            color: #fbbf24;
        }
        
        .card {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .recommendation-badge {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stock-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #2a3a80 0%, #36a0ae 100%);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .chart-container {
            width: 100%;
            height: 200px;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .chart-line {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            fill: none;
            stroke: #4ade80;
            stroke-width: 2;
            stroke-linecap: round;
        }
        
        .chart-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            fill: url(#chartGradient);
        }
        
        .chart-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            background-color: rgba(79, 209, 197, 0.9);
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateY(0);
        }
        
        .api-key-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .error-notification {
            background-color: rgba(239, 68, 68, 0.9);
        }
        
        .warning-notification {
            background-color: rgba(245, 158, 11, 0.9);
        }
        
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- API Key Modal -->
    <div id="api-key-modal" class="api-key-modal">
        <div class="modal-content relative p-6">
            <h2 class="text-2xl font-bold mb-4 text-white">設定 Alpha Vantage API 金鑰</h2>
            <p class="mb-4 text-white">請輸入您的 Alpha Vantage API 金鑰以獲取即時股票數據。<br>
            您可以在 <a href="https://www.alphavantage.co/support/#api-key" target="_blank" class="text-blue-300 underline">Alpha Vantage</a> 免費註冊獲取。</p>
            
            <input type="text" id="api-key-input" placeholder="輸入您的 API 金鑰" class="w-full p-3 rounded-lg mb-4 bg-white bg-opacity-10 border border-white border-opacity-20 text-white">
            
            <div class="flex justify-between">
                <button id="test-api-key" class="bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                    測試金鑰
                </button>
                <button id="save-api-key" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                    儲存並開始使用
                </button>
            </div>
            
            <div id="api-test-result" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-6 text-white text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">股票推薦系統</h1>
            <p class="text-lg opacity-80">即時市場分析與推薦</p>
        </header>
        
        <!-- 股票推薦跑馬燈 -->
        <div class="ticker-container rounded-lg mb-8">
            <div class="ticker py-3 text-white font-medium" id="ticker">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 熱門推薦股票 -->
            <div class="card rounded-xl p-6 text-white">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    熱門推薦
                </h2>
                <ul class="space-y-4" id="hot-recommendations">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </ul>
            </div>
            
            <!-- 長期投資 -->
            <div class="card rounded-xl p-6 text-white">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    長期投資
                </h2>
                <ul class="space-y-4" id="long-term">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </ul>
            </div>
            
            <!-- 市場概況 -->
            <div class="card rounded-xl p-6 text-white">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    市場概況
                </h2>
                <div class="space-y-3" id="market-overview">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 搜尋與篩選 -->
        <div class="mt-8 card rounded-xl p-6 text-white">
            <h2 class="text-xl font-bold mb-4">自訂篩選</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block mb-2 text-sm">產業類別</label>
                    <select id="industry-filter" class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white">
                        <option value="all">全部產業</option>
                        <option value="TECHNOLOGY">科技業</option>
                        <option value="FINANCIAL_SERVICES">金融業</option>
                        <option value="INDUSTRIALS">製造業</option>
                        <option value="CONSUMER_CYCLICAL">消費循環</option>
                        <option value="COMMUNICATION_SERVICES">通訊服務</option>
                        <option value="HEALTHCARE">醫療保健</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 text-sm">投資風格</label>
                    <select id="style-filter" class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white">
                        <option value="all">不限</option>
                        <option value="growth">成長型</option>
                        <option value="value">價值型</option>
                        <option value="dividend">高股息</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 text-sm">市值規模</label>
                    <select id="size-filter" class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white">
                        <option value="all">不限</option>
                        <option value="large">大型股</option>
                        <option value="mid">中型股</option>
                        <option value="small">小型股</option>
                    </select>
                </div>
            </div>
            <button id="apply-filter" class="mt-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                套用篩選
            </button>
        </div>
        
        <!-- 新增: 訂閱推薦 -->
        <div class="mt-8 card rounded-xl p-6 text-white">
            <h2 class="text-xl font-bold mb-4">訂閱股票推薦</h2>
            <p class="mb-4 opacity-80">輸入您的電子郵件，獲取每日股票推薦與市場分析</p>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="email" id="email-input" placeholder="您的電子郵件" class="flex-grow bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white">
                <button id="subscribe-btn" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                    訂閱
                </button>
            </div>
        </div>
        
        <!-- API 設定 -->
        <div class="mt-8 card rounded-xl p-6 text-white">
            <h2 class="text-xl font-bold mb-4">API 設定</h2>
            <p class="mb-4 opacity-80">您可以更改 Alpha Vantage API 金鑰或調整數據更新頻率</p>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="api-key-display" placeholder="您的 API 金鑰" class="flex-grow bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white" readonly>
                <button id="change-api-key" class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                    更改金鑰
                </button>
            </div>
            <div class="mt-4">
                <label class="block mb-2 text-sm">數據更新頻率 (分鐘)</label>
                <select id="update-frequency" class="w-full md:w-1/3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white">
                    <option value="1">1 分鐘</option>
                    <option value="5" selected>5 分鐘</option>
                    <option value="15">15 分鐘</option>
                    <option value="30">30 分鐘</option>
                    <option value="60">60 分鐘</option>
                </select>
            </div>
            <div class="mt-4">
                <label class="block mb-2 text-sm">數據來源模式</label>
                <select id="data-source-mode" class="w-full md:w-1/3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg p-2 text-white">
                    <option value="api">優先使用 API 數據</option>
                    <option value="demo">使用模擬數據 (不消耗 API 配額)</option>
                </select>
            </div>
            <div class="mt-4 flex items-center">
                <input type="checkbox" id="debug-mode" class="mr-2">
                <label for="debug-mode" class="text-sm">啟用除錯模式</label>
            </div>
        </div>
    </div>
    
    <!-- 股票詳情彈窗 -->
    <div id="stock-detail-modal" class="stock-detail-modal">
        <div class="modal-content relative">
            <span class="close-modal" id="close-modal">&times;</span>
            <div id="modal-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知元素 -->
    <div id="notification" class="notification">
        <div id="notification-content"></div>
    </div>
    
    <!-- 除錯面板 -->
    <div id="debug-panel" class="debug-panel"></div>
    
    <!-- SVG 定義 -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="rgba(74, 222, 128, 0.6)" />
                <stop offset="100%" stop-color="rgba(74, 222, 128, 0)" />
            </linearGradient>
        </defs>
    </svg>

    <script>
        // 全局變數
        let apiKey = localStorage.getItem('alphavantage_api_key') || '';
        let updateFrequency = parseInt(localStorage.getItem('update_frequency') || '5');
        let dataSourceMode = localStorage.getItem('data_source_mode') || 'api';
        let debugMode = localStorage.getItem('debug_mode') === 'true';
        let updateInterval;
        let stockCache = {};
        let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
        let apiCallCount = 0;
        let lastApiReset = Date.now();
        
        // 股票資料 - 包含台股和美股
        const stockSymbols = {
            // 台股
            'Taiwan': [
                { symbol: '2330.TW', name: '台積電', industry: 'TECHNOLOGY', style: 'value', size: 'large', reason: '先進製程領先全球，AI晶片需求強勁' },
                { symbol: '2317.TW', name: '鴻海', industry: 'TECHNOLOGY', style: 'value', size: 'large', reason: '電動車布局加速，轉型效益顯現' },
                { symbol: '2454.TW', name: '聯發科', industry: 'TECHNOLOGY', style: 'growth', size: 'large', reason: '手機晶片市占率持續提升' },
                { symbol: '2412.TW', name: '中華電', industry: 'COMMUNICATION_SERVICES', style: 'dividend', size: 'large', reason: '5G布局完善，高股息率，穩定獲利' },
                { symbol: '2308.TW', name: '台達電', industry: 'TECHNOLOGY', style: 'value', size: 'large', reason: '電源管理解決方案領導者' },
                { symbol: '2881.TW', name: '富邦金', industry: 'FINANCIAL_SERVICES', style: 'dividend', size: 'large', reason: '金融業龍頭，數位金融轉型成功' },
                { symbol: '1301.TW', name: '台塑', industry: 'INDUSTRIALS', style: 'value', size: 'large', reason: '石化產業龍頭，產品線完整' },
                { symbol: '2882.TW', name: '國泰金', industry: 'FINANCIAL_SERVICES', style: 'dividend', size: 'large', reason: '金控龍頭，多元業務布局，股息穩定' }
            ],
            // 美股
            'US': [
                { symbol: 'AAPL', name: '蘋果', industry: 'TECHNOLOGY', style: 'growth', size: 'large', reason: '產品生態系完整，服務收入持續成長' },
                { symbol: 'MSFT', name: '微軟', industry: 'TECHNOLOGY', style: 'growth', size: 'large', reason: '雲端業務Azure成長強勁，AI整合領先' },
                { symbol: 'GOOGL', name: '谷歌', industry: 'COMMUNICATION_SERVICES', style: 'growth', size: 'large', reason: '數位廣告龍頭，AI技術領先' },
                { symbol: 'AMZN', name: '亞馬遜', industry: 'CONSUMER_CYCLICAL', style: 'growth', size: 'large', reason: '電商與雲端AWS雙引擎成長' },
                { symbol: 'NVDA', name: '輝達', industry: 'TECHNOLOGY', style: 'growth', size: 'large', reason: 'AI晶片需求爆發，資料中心業務強勁' },
                { symbol: 'JNJ', name: '嬌生', industry: 'HEALTHCARE', style: 'dividend', size: 'large', reason: '醫療保健龍頭，穩定現金流與股息' },
                { symbol: 'JPM', name: '摩根大通', industry: 'FINANCIAL_SERVICES', style: 'value', size: 'large', reason: '銀行業龍頭，利率環境有利獲利' }
            ]
        };
        
        // 長期投資推薦
        const longTermStocks = ['2330.TW', '2412.TW', 'MSFT', 'JNJ'];
        
        // 市場指數
        const marketIndices = [
            { symbol: '^TWII', name: '台灣加權指數', region: 'Taiwan' },
            { symbol: '^DJI', name: '美國道瓊', region: 'US' },
            { symbol: '^IXIC', name: '納斯達克', region: 'US' },
            { symbol: '^GSPC', name: 'S&P 500', region: 'US' }
        ];
        
        // 初始化頁面
        function initPage() {
            // 檢查API金鑰
            if (!apiKey) {
                document.getElementById('api-key-modal').style.display = 'flex';
            } else {
                document.getElementById('api-key-display').value = maskApiKey(apiKey);
                loadAllData();
            }
            
            // 設定更新頻率選擇器
            document.getElementById('update-frequency').value = updateFrequency.toString();
            document.getElementById('data-source-mode').value = dataSourceMode;
            document.getElementById('debug-mode').checked = debugMode;
            
            if (debugMode) {
                document.getElementById('debug-panel').style.display = 'block';
            }
            
            // 添加事件監聽器
            document.getElementById('save-api-key').addEventListener('click', saveApiKey);
            document.getElementById('test-api-key').addEventListener('click', testApiKey);
            document.getElementById('change-api-key').addEventListener('click', showApiKeyModal);
            document.getElementById('apply-filter').addEventListener('click', filterStocks);
            document.getElementById('subscribe-btn').addEventListener('click', subscribeNewsletter);
            document.getElementById('close-modal').addEventListener('click', closeStockDetailModal);
            document.getElementById('update-frequency').addEventListener('change', changeUpdateFrequency);
            document.getElementById('data-source-mode').addEventListener('change', changeDataSourceMode);
            document.getElementById('debug-mode').addEventListener('change', toggleDebugMode);
            
            // 點擊模態框外部關閉
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('stock-detail-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // 保存API金鑰
        function saveApiKey() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            if (inputKey) {
                apiKey = inputKey;
                localStorage.setItem('alphavantage_api_key', apiKey);
                document.getElementById('api-key-modal').style.display = 'none';
                document.getElementById('api-key-display').value = maskApiKey(apiKey);
                
                // 重置API調用計數
                apiCallCount = 0;
                lastApiReset = Date.now();
                
                loadAllData();
            } else {
                showNotification('請輸入有效的 API 金鑰', 'error');
            }
        }
        
        // 測試API金鑰
        async function testApiKey() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            const resultElement = document.getElementById('api-test-result');
            
            if (!inputKey) {
                resultElement.innerHTML = '請輸入 API 金鑰進行測試';
                resultElement.className = 'mt-4 p-3 rounded-lg bg-red-500 bg-opacity-50 text-white';
                resultElement.style.display = 'block';
                return;
            }
            
            resultElement.innerHTML = '測試中...';
            resultElement.className = 'mt-4 p-3 rounded-lg bg-blue-500 bg-opacity-50 text-white';
            resultElement.style.display = 'block';
            
            try {
                // 使用 Alpha Vantage API 測試金鑰
                const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=AAPL&apikey=${inputKey}`);
                const data = await response.json();
                
                if (data['Global Quote'] && Object.keys(data['Global Quote']).length > 0) {
                    resultElement.innerHTML = '✅ API 金鑰有效！可以正常獲取股票數據。';
                    resultElement.className = 'mt-4 p-3 rounded-lg bg-green-500 bg-opacity-50 text-white';
                } else if (data['Note'] && data['Note'].includes('API call frequency')) {
                    resultElement.innerHTML = '⚠️ API 金鑰有效，但已達到調用頻率限制。請稍後再試或使用模擬數據模式。';
                    resultElement.className = 'mt-4 p-3 rounded-lg bg-yellow-500 bg-opacity-50 text-white';
                } else if (data['Error Message'] && data['Error Message'].includes('Invalid API call')) {
                    resultElement.innerHTML = '❌ API 金鑰無效。請檢查您的金鑰是否正確。';
                    resultElement.className = 'mt-4 p-3 rounded-lg bg-red-500 bg-opacity-50 text-white';
                } else {
                    resultElement.innerHTML = '⚠️ API 回應異常，但金鑰可能有效。您可以嘗試使用此金鑰。';
                    resultElement.className = 'mt-4 p-3 rounded-lg bg-yellow-500 bg-opacity-50 text-white';
                }
                
                // 顯示原始回應以便調試
                if (debugMode) {
                    const responseText = JSON.stringify(data, null, 2);
                    resultElement.innerHTML += `<div class="mt-2 text-xs overflow-auto max-h-32 bg-black bg-opacity-50 p-2 rounded">API 回應: ${responseText}</div>`;
                }
            } catch (error) {
                resultElement.innerHTML = `❌ 測試失敗: ${error.message}。請檢查您的網絡連接。`;
                resultElement.className = 'mt-4 p-3 rounded-lg bg-red-500 bg-opacity-50 text-white';
                
                if (debugMode) {
                    resultElement.innerHTML += `<div class="mt-2 text-xs">${error.stack}</div>`;
                }
            }
        }
        
        // 顯示API金鑰設定模態框
        function showApiKeyModal() {
            document.getElementById('api-key-input').value = apiKey;
            document.getElementById('api-test-result').style.display = 'none';
            document.getElementById('api-key-modal').style.display = 'flex';
        }
        
        // 遮罩API金鑰
        function maskApiKey(key) {
            if (key.length <= 8) return '********';
            return key.substring(0, 4) + '****' + key.substring(key.length - 4);
        }
        
        // 更改數據更新頻率
        function changeUpdateFrequency() {
            const newFrequency = parseInt(document.getElementById('update-frequency').value);
            updateFrequency = newFrequency;
            localStorage.setItem('update_frequency', newFrequency.toString());
            
            // 重設更新間隔
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(loadAllData, updateFrequency * 60 * 1000);
            
            showNotification(`數據更新頻率已設為 ${updateFrequency} 分鐘`);
        }
        
        // 更改數據來源模式
        function changeDataSourceMode() {
            const newMode = document.getElementById('data-source-mode').value;
            dataSourceMode = newMode;
            localStorage.setItem('data_source_mode', newMode);
            
            if (newMode === 'demo') {
                showNotification('已切換至模擬數據模式，不會消耗 API 配額', 'warning');
            } else {
                showNotification('已切換至 API 數據模式');
            }
            
            // 清除緩存並重新加載數據
            stockCache = {};
            loadAllData();
        }
        
        // 切換除錯模式
        function toggleDebugMode() {
            debugMode = document.getElementById('debug-mode').checked;
            localStorage.setItem('debug_mode', debugMode.toString());
            
            if (debugMode) {
                document.getElementById('debug-panel').style.display = 'block';
                showNotification('已啟用除錯模式');
            } else {
                document.getElementById('debug-panel').style.display = 'none';
                showNotification('已關閉除錯模式');
            }
        }
        
        // 加載所有數據
        function loadAllData() {
            loadStockData();
            loadMarketIndices();
        }
        
        // 加載股票數據
        async function loadStockData() {
            if (!apiKey && dataSourceMode === 'api') {
                showNotification('請先設定 API 金鑰', 'error');
                return;
            }
            
            // 合併台股和美股
            const allStocks = [...stockSymbols.Taiwan, ...stockSymbols.US];
            
            // 顯示加載中
            document.getElementById('ticker').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            document.getElementById('hot-recommendations').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            document.getElementById('long-term').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                // 使用 Promise.all 並行請求數據
                const promises = allStocks.map(stock => fetchStockData(stock.symbol));
                await Promise.all(promises);
                
                // 更新UI
                generateTicker();
                generateHotRecommendations();
                generateLongTermRecommendations();
                
                // 更新最後更新時間
                updateLastUpdateTime();
            } catch (error) {
                console.error('加載股票數據時出錯:', error);
                logDebug(`加載股票數據錯誤: ${error.message}`);
                showNotification('加載股票數據時出錯，請檢查您的API金鑰或網絡連接', 'error');
                
                // 使用備用數據
                allStocks.forEach(stock => {
                    if (!stockCache[stock.symbol]) {
                        stockCache[stock.symbol] = {
                            data: generateFallbackStockData(stock.symbol),
                            timestamp: Date.now()
                        };
                    }
                });
                
                // 更新UI
                generateTicker();
                generateHotRecommendations();
                generateLongTermRecommendations();
                updateLastUpdateTime();
            }
        }
        
        // 獲取單個股票數據
        async function fetchStockData(symbol) {
            // 檢查緩存
            const now = Date.now();
            if (stockCache[symbol] && (now - stockCache[symbol].timestamp) < updateFrequency * 60 * 1000) {
                return stockCache[symbol].data;
            }
            
            // 如果使用模擬數據模式，直接返回模擬數據
            if (dataSourceMode === 'demo') {
                const fallbackData = generateFallbackStockData(symbol);
                stockCache[symbol] = {
                    data: fallbackData,
                    timestamp: now
                };
                return fallbackData;
            }
            
            // 檢查API調用限制
            if (checkApiRateLimit()) {
                try {
                    // 使用 Alpha Vantage API 獲取全球報價
                    logDebug(`正在獲取 ${symbol} 的數據...`);
                    const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`);
                    const data = await response.json();
                    
                    // 增加API調用計數
                    apiCallCount++;
                    
                    // 記錄API回應
                    logDebug(`${symbol} API回應: ${JSON.stringify(data)}`);
                    
                    if (data['Global Quote'] && Object.keys(data['Global Quote']).length > 0) {
                        const quote = data['Global Quote'];
                        const price = parseFloat(quote['05. price']);
                        const previousClose = parseFloat(quote['08. previous close']);
                        const change = ((price - previousClose) / previousClose) * 100;
                        
                        // 找到股票的基本信息
                        let stockInfo = null;
                        for (const region in stockSymbols) {
                            const found = stockSymbols[region].find(s => s.symbol === symbol);
                            if (found) {
                                stockInfo = found;
                                break;
                            }
                        }
                        
                        if (stockInfo) {
                            // 更新股票數據
                            const updatedStock = {
                                ...stockInfo,
                                price: price.toFixed(2),
                                change: change.toFixed(2),
                                recommendation: Math.abs(change) > 1.5 && change > 0 // 簡單推薦邏輯：漲幅超過1.5%
                            };
                            
                            // 更新緩存
                            stockCache[symbol] = {
                                data: updatedStock,
                                timestamp: now
                            };
                            
                            // 獲取歷史數據
                            fetchHistoricalData(symbol);
                            
                            return updatedStock;
                        }
                    } else if (data['Note']) {
                        logDebug(`API 調用頻率限制: ${data['Note']}`);
                        showNotification('API 調用頻率已達上限，已切換至模擬數據模式', 'warning');
                        
                        // 自動切換到模擬數據模式
                        document.getElementById('data-source-mode').value = 'demo';
                        dataSourceMode = 'demo';
                        localStorage.setItem('data_source_mode', 'demo');
                    } else if (data['Error Message']) {
                        logDebug(`API 錯誤: ${data['Error Message']}`);
                        showNotification(`API 錯誤: ${data['Error Message']}`, 'error');
                    }
                } catch (error) {
                    logDebug(`獲取 ${symbol} 數據時出錯: ${error.message}`);
                    console.error(`獲取 ${symbol} 數據時出錯:`, error);
                }
            } else {
                logDebug(`API 調用頻率超限，使用模擬數據: ${symbol}`);
            }
            
            // 如果API調用失敗，使用模擬數據
            const fallbackData = generateFallbackStockData(symbol);
            stockCache[symbol] = {
                data: fallbackData,
                timestamp: now
            };
            return fallbackData;
        }
        
        // 獲取歷史數據
        async function fetchHistoricalData(symbol) {
            if (!apiKey || dataSourceMode === 'demo') return generateFallbackHistoricalData(symbol);
            
            // 檢查緩存
            const cacheKey = `${symbol}_history`;
            const now = Date.now();
            if (stockCache[cacheKey] && (now - stockCache[cacheKey].timestamp) < 24 * 60 * 60 * 1000) {
                return stockCache[cacheKey].data;
            }
            
            // 檢查API調用限制
            if (checkApiRateLimit()) {
                try {
                    // 使用 Alpha Vantage API 獲取每日時間序列
                    logDebug(`正在獲取 ${symbol} 的歷史數據...`);
                    const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&outputsize=compact&apikey=${apiKey}`);
                    const data = await response.json();
                    
                    // 增加API調用計數
                    apiCallCount++;
                    
                    if (data['Time Series (Daily)']) {
                        const timeSeries = data['Time Series (Daily)'];
                        const historicalData = [];
                        
                        // 只取最近30天的數據
                        let count = 0;
                        for (const date in timeSeries) {
                            if (count >= 30) break;
                            
                            historicalData.push({
                                date: new Date(date),
                                price: parseFloat(timeSeries[date]['4. close'])
                            });
                            
                            count++;
                        }
                        
                        // 按日期排序
                        historicalData.sort((a, b) => a.date - b.date);
                        
                        // 更新緩存
                        stockCache[cacheKey] = {
                            data: historicalData,
                            timestamp: now
                        };
                        
                        return historicalData;
                    } else if (data['Note']) {
                        logDebug(`API 調用頻率限制 (歷史數據): ${data['Note']}`);
                    } else if (data['Error Message']) {
                        logDebug(`API 錯誤 (歷史數據): ${data['Error Message']}`);
                    }
                } catch (error) {
                    logDebug(`獲取 ${symbol} 歷史數據時出錯: ${error.message}`);
                    console.error(`獲取 ${symbol} 歷史數據時出錯:`, error);
                }
            }
            
            // 如果API調用失敗，使用模擬數據
            const fallbackData = generateFallbackHistoricalData(symbol);
            stockCache[cacheKey] = {
                data: fallbackData,
                timestamp: now
            };
            return fallbackData;
        }
        
        // 加載市場指數
        async function loadMarketIndices() {
            if (!apiKey && dataSourceMode === 'api') return;
            
            // 顯示加載中
            document.getElementById('market-overview').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                // 使用 Promise.all 並行請求數據
                const promises = marketIndices.map(index => fetchMarketIndex(index.symbol));
                await Promise.all(promises);
                
                // 更新UI
                generateMarketOverview();
            } catch (error) {
                console.error('加載市場指數時出錯:', error);
                logDebug(`加載市場指數錯誤: ${error.message}`);
                showNotification('加載市場指數時出錯，請檢查您的API金鑰或網絡連接', 'error');
                
                // 使用備用數據
                marketIndices.forEach(index => {
                    if (!stockCache[index.symbol]) {
                        stockCache[index.symbol] = {
                            data: generateFallbackMarketIndex(index.symbol),
                            timestamp: Date.now()
                        };
                    }
                });
                
                // 更新UI
                generateMarketOverview();
            }
        }
        
        // 獲取市場指數數據
        async function fetchMarketIndex(symbol) {
            // 檢查緩存
            const now = Date.now();
            if (stockCache[symbol] && (now - stockCache[symbol].timestamp) < updateFrequency * 60 * 1000) {
                return stockCache[symbol].data;
            }
            
            // 如果使用模擬數據模式，直接返回模擬數據
            if (dataSourceMode === 'demo') {
                const fallbackData = generateFallbackMarketIndex(symbol);
                stockCache[symbol] = {
                    data: fallbackData,
                    timestamp: now
                };
                return fallbackData;
            }
            
            // 檢查API調用限制
            if (checkApiRateLimit()) {
                try {
                    // 使用 Alpha Vantage API 獲取全球報價
                    logDebug(`正在獲取指數 ${symbol} 的數據...`);
                    const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`);
                    const data = await response.json();
                    
                    // 增加API調用計數
                    apiCallCount++;
                    
                    // 記錄API回應
                    logDebug(`指數 ${symbol} API回應: ${JSON.stringify(data)}`);
                    
                    if (data['Global Quote'] && Object.keys(data['Global Quote']).length > 0) {
                        const quote = data['Global Quote'];
                        const price = parseFloat(quote['05. price']);
                        const previousClose = parseFloat(quote['08. previous close']);
                        const change = ((price - previousClose) / previousClose) * 100;
                        
                        // 找到指數的基本信息
                        const indexInfo = marketIndices.find(idx => idx.symbol === symbol);
                        
                        if (indexInfo) {
                            // 更新指數數據
                            const updatedIndex = {
                                ...indexInfo,
                                price: price,
                                change: change
                            };
                            
                            // 更新緩存
                            stockCache[symbol] = {
                                data: updatedIndex,
                                timestamp: now
                            };
                            
                            return updatedIndex;
                        }
                    } else if (data['Note']) {
                        logDebug(`API 調用頻率限制 (指數): ${data['Note']}`);
                    } else if (data['Error Message']) {
                        logDebug(`API 錯誤 (指數): ${data['Error Message']}`);
                    }
                } catch (error) {
                    logDebug(`獲取指數 ${symbol} 數據時出錯: ${error.message}`);
                    console.error(`獲取指數 ${symbol} 數據時出錯:`, error);
                }
            }
            
            // 如果API調用失敗，使用模擬數據
            const fallbackData = generateFallbackMarketIndex(symbol);
            stockCache[symbol] = {
                data: fallbackData,
                timestamp: now
            };
            return fallbackData;
        }
        
        // 檢查API調用頻率限制
        function checkApiRateLimit() {
            // Alpha Vantage 免費版限制：每分鐘 5 次，每天 500 次
            const now = Date.now();
            const minutesPassed = (now - lastApiReset) / (60 * 1000);
            
            // 如果已經過了一分鐘，重置計數器
            if (minutesPassed >= 1) {
                apiCallCount = 0;
                lastApiReset = now;
                return true;
            }
            
            // 如果在一分鐘內已經調用了 5 次，則返回 false
            if (apiCallCount >= 5) {
                logDebug(`API 調用頻率超限: ${apiCallCount} 次/分鐘`);
                return false;
            }
            
            return true;
        }
        
        // 生成跑馬燈內容
        function generateTicker() {
            const ticker = document.getElementById('ticker');
            let tickerContent = '';
            
            // 合併台股和美股
            const allStocks = [...stockSymbols.Taiwan, ...stockSymbols.US];
            
            allStocks.forEach(stockInfo => {
                const symbol = stockInfo.symbol;
                const stock = stockCache[symbol]?.data;
                
                if (stock) {
                    const changeClass = parseFloat(stock.change) > 0 ? 'up' : (parseFloat(stock.change) < 0 ? 'down' : 'neutral');
                    const changeSymbol = parseFloat(stock.change) > 0 ? '▲' : (parseFloat(stock.change) < 0 ? '▼' : '■');
                    const recommendationBadge = stock.recommendation ? '<span class="recommendation-badge">推薦</span>' : '';
                    
                    tickerContent += 
                        <div class="stock-item" data-symbol="${stock.symbol}">
                            <span class="font-bold">${stock.symbol} ${stock.name}</span>
                            <span class="${changeClass}">${stock.price} ${changeSymbol} ${Math.abs(parseFloat(stock.change))}%</span>
                            ${recommendationBadge}
                        </div>
                    ;
                }
            });
            
            if (tickerContent) {
                ticker.innerHTML = tickerContent + tickerContent; // 重複內容以確保連續滾動
                
                // 添加點擊事件
                const stockItems = document.querySelectorAll('.stock-item');
                stockItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const symbol = item.getAttribute('data-symbol');
                        showStockDetail(symbol);
                    });
                });
            } else {
                ticker.innerHTML = '<div class="p-3 text-center">無法獲取股票數據，請檢查API金鑰或網絡連接</div>';
            }
        }
        
        // 生成熱門推薦
        function generateHotRecommendations() {
            const hotRecommendationsEl = document.getElementById('hot-recommendations');
            
            // 合併台股和美股
            const allStocks = [...stockSymbols.Taiwan, ...stockSymbols.US];
            
            // 篩選推薦股票
            const recommendations = [];
            allStocks.forEach(stockInfo => {
                const symbol = stockInfo.symbol;
                const stock = stockCache[symbol]?.data;
                
                if (stock && stock.recommendation) {
                    recommendations.push(stock);
                }
            });
            
            if (recommendations.length === 0) {
                hotRecommendationsEl.innerHTML = '<div class="p-3 text-center opacity-70">目前沒有推薦股票</div>';
                return;
            }
            
            let content = '';
            recommendations.forEach(stock => {
                const changeClass = parseFloat(stock.change) > 0 ? 'up' : (parseFloat(stock.change) < 0 ? 'down' : 'neutral');
                const changeSymbol = parseFloat(stock.change) > 0 ? '▲' : (parseFloat(stock.change) < 0 ? '▼' : '■');
                
                content += 
                    <li class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg hover:bg-opacity-10 transition duration-300 cursor-pointer" data-symbol="${stock.symbol}">
                        <div>
                            <div class="font-bold">${stock.symbol} ${stock.name}</div>
                            <div class="text-sm opacity-80">推薦理由: ${stock.reason}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${changeClass}">${stock.price}</div>
                            <div class="text-sm ${changeClass}">${changeSymbol} ${Math.abs(parseFloat(stock.change))}%</div>
                        </div>
                    </li>
                ;
            });
            
            hotRecommendationsEl.innerHTML = content;
            
            // 添加點擊事件
            const stockItems = document.querySelectorAll('#hot-recommendations li');
            stockItems.forEach(item => {
                item.addEventListener('click', () => {
                    const symbol = item.getAttribute('data-symbol');
                    showStockDetail(symbol);
                });
            });
        }
        
        // 生成長期投資推薦
        function generateLongTermRecommendations() {
            const longTermEl = document.getElementById('long-term');
            
            // 篩選長期投資股票
            const longTermRecs = [];
            longTermStocks.forEach(symbol => {
                const stock = stockCache[symbol]?.data;
                if (stock) {
                    longTermRecs.push(stock);
                }
            });
            
            if (longTermRecs.length === 0) {
                longTermEl.innerHTML = '<div class="p-3 text-center opacity-70">無法獲取長期投資推薦</div>';
                return;
            }
            
            let content = '';
            longTermRecs.forEach(stock => {
                const changeClass = parseFloat(stock.change) > 0 ? 'up' : (parseFloat(stock.change) < 0 ? 'down' : 'neutral');
                const changeSymbol = parseFloat(stock.change) > 0 ? '▲' : (parseFloat(stock.change) < 0 ? '▼' : '■');
                
                content += 
                    <li class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg hover:bg-opacity-10 transition duration-300 cursor-pointer" data-symbol="${stock.symbol}">
                        <div>
                            <div class="font-bold">${stock.symbol} ${stock.name}</div>
                            <div class="text-sm opacity-80">${stock.reason}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${changeClass}">${stock.price}</div>
                            <div class="text-sm ${changeClass}">${changeSymbol} ${Math.abs(parseFloat(stock.change))}%</div>
                        </div>
                    </li>
                ;
            });
            
            longTermEl.innerHTML = content;
            
            // 添加點擊事件
            const stockItems = document.querySelectorAll('#long-term li');
            stockItems.forEach(item => {
                item.addEventListener('click', () => {
                    const symbol = item.getAttribute('data-symbol');
                    showStockDetail(symbol);
                });
            });
        }
        
        // 生成市場概況
        function generateMarketOverview() {
            const marketOverviewEl = document.getElementById('market-overview');
            
            let content = '';
            marketIndices.forEach(indexInfo => {
                const symbol = indexInfo.symbol;
                const index = stockCache[symbol]?.data;
                
                if (index) {
                    const changeClass = parseFloat(index.change) > 0 ? 'up' : (parseFloat(index.change) < 0 ? 'down' : 'neutral');
                    
                    content += 
                        <div class="flex justify-between items-center">
                            <span>${index.name}</span>
                            <span class="${changeClass} font-medium">${index.price.toFixed(2)} <span class="text-sm">${index.change > 0 ? '+' : ''}${index.change.toFixed(2)}%</span></span>
                        </div>
                    ;
                }
            });
            
            // 添加最後更新時間和數據來源
            const now = new Date();
            const formattedDate = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            content += 
                <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                    <p class="text-sm opacity-80">最後更新: <span id="last-update">${formattedDate}</span></p>
                    <p class="text-sm opacity-80">數據來源: ${dataSourceMode === 'api' ? 'Alpha Vantage API' : '模擬數據'}</p>
                </div>
            ;
            
            marketOverviewEl.innerHTML = content;
        }
        
        // 更新最後更新時間
        function updateLastUpdateTime() {
            const now = new Date();
            const formattedDate = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const lastUpdateEl = document.getElementById('last-update');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = formattedDate;
            }
        }
        
        // 篩選股票
        function filterStocks() {
            const industryFilter = document.getElementById('industry-filter').value;
            const styleFilter = document.getElementById('style-filter').value;
            const sizeFilter = document.getElementById('size-filter').value;
            
            // 合併台股和美股
            const allStocks = [...stockSymbols.Taiwan, ...stockSymbols.US];
            
            // 篩選股票
            const filteredStocks = [];
            allStocks.forEach(stockInfo => {
                const symbol = stockInfo.symbol;
                const stock = stockCache[symbol]?.data;
                
                if (stock) {
                    const matchIndustry = industryFilter === 'all' || stock.industry === industryFilter;
                    const matchStyle = styleFilter === 'all' || stock.style === styleFilter;
                    const matchSize = sizeFilter === 'all' || stock.size === sizeFilter;
                    
                    if (matchIndustry && matchStyle && matchSize) {
                        filteredStocks.push(stock);
                    }
                }
            });
            
            // 更新推薦列表
            const hotRecommendationsEl = document.getElementById('hot-recommendations');
            const recommendations = filteredStocks.filter(stock => stock.recommendation);
            
            if (recommendations.length === 0) {
                hotRecommendationsEl.innerHTML = '<div class="p-3 text-center opacity-70">沒有符合條件的推薦股票</div>';
            } else {
                let content = '';
                recommendations.forEach(stock => {
                    const changeClass = parseFloat(stock.change) > 0 ? 'up' : (parseFloat(stock.change) < 0 ? 'down' : 'neutral');
                    const changeSymbol = parseFloat(stock.change) > 0 ? '▲' : (parseFloat(stock.change) < 0 ? '▼' : '■');
                    
                    content += 
                        <li class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg hover:bg-opacity-10 transition duration-300 cursor-pointer" data-symbol="${stock.symbol}">
                            <div>
                                <div class="font-bold">${stock.symbol} ${stock.name}</div>
                                <div class="text-sm opacity-80">推薦理由: ${stock.reason}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold ${changeClass}">${stock.price}</div>
                                <div class="text-sm ${changeClass}">${changeSymbol} ${Math.abs(parseFloat(stock.change))}%</div>
                            </div>
                        </li>
                    ;
                });
                
                hotRecommendationsEl.innerHTML = content;
                
                // 添加點擊事件
                const stockItems = document.querySelectorAll('#hot-recommendations li');
                stockItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const symbol = item.getAttribute('data-symbol');
                        showStockDetail(symbol);
                    });
                });
            }
            
            // 更新長期投資列表
            const longTermEl = document.getElementById('long-term');
            const longTermRecs = filteredStocks.filter(stock => longTermStocks.includes(stock.symbol));
            
            if (longTermRecs.length === 0) {
                longTermEl.innerHTML = '<div class="p-3 text-center opacity-70">沒有符合條件的長期投資推薦</div>';
            } else {
                let content = '';
                longTermRecs.forEach(stock => {
                    const changeClass = parseFloat(stock.change) > 0 ? 'up' : (parseFloat(stock.change) < 0 ? 'down' : 'neutral');
                    const changeSymbol = parseFloat(stock.change) > 0 ? '▲' : (parseFloat(stock.change) < 0 ? '▼' : '■');
                    
                    content += 
                        <li class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg hover:bg-opacity-10 transition duration-300 cursor-pointer" data-symbol="${stock.symbol}">
                            <div>
                                <div class="font-bold">${stock.symbol} ${stock.name}</div>
                                <div class="text-sm opacity-80">${stock.reason}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold ${changeClass}">${stock.price}</div>
                                <div class="text-sm ${changeClass}">${changeSymbol} ${Math.abs(parseFloat(stock.change))}%</div>
                            </div>
                        </li>
                    ;
                });
                
                longTermEl.innerHTML = content;
                
                // 添加點擊事件
                const stockItems = document.querySelectorAll('#long-term li');
                stockItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const symbol = item.getAttribute('data-symbol');
                        showStockDetail(symbol);
                    });
                });
            }
            
            // 顯示篩選通知
            showNotification('已套用篩選條件');
        }
        
        // 訂閱電子報
        function subscribeNewsletter() {
            const email = document.getElementById('email-input').value;
            if (email && email.includes('@')) {
                showNotification('訂閱成功！您將收到每日股票推薦');
                document.getElementById('email-input').value = '';
            } else {
                showNotification('請輸入有效的電子郵件地址', 'error');
            }
        }
        
        // 顯示股票詳情
        async function showStockDetail(symbol) {
            const modal = document.getElementById('stock-detail-modal');
            const modalContent = document.getElementById('modal-content');
            
            // 顯示加載中
            modalContent.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            modal.style.display = 'flex';
            
            // 獲取股票數據
            const stock = stockCache[symbol]?.data;
            if (!stock) {
                modalContent.innerHTML = '<div class="p-4 text-center">無法獲取股票數據</div>';
                return;
            }
            
            // 獲取歷史數據
            const cacheKey = ${symbol}_history;
            let historicalData = stockCache[cacheKey]?.data;
            
            if (!historicalData) {
                historicalData = await fetchHistoricalData(symbol);
            }
            
            const changeClass = parseFloat(stock.change) > 0 ? 'up' : (parseFloat(stock.change) < 0 ? 'down' : 'neutral');
            const changeSymbol = parseFloat(stock.change) > 0 ? '▲' : (parseFloat(stock.change) < 0 ? '▼' : '■');
            
            // 生成股價走勢圖
            const chartPoints = generateChartPoints(historicalData);
            
            // 檢查是否在追蹤清單中
            const isInWatchlist = watchlist.includes(symbol);
            const watchlistBtnText = isInWatchlist ? '移除追蹤' : '加入追蹤';
            const watchlistBtnClass = isInWatchlist ? 
                'bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700' : 
                'bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700';
            
            // 顯示數據來源
            const dataSourceText = dataSourceMode === 'api' ? 'Alpha Vantage API' : '模擬數據';
            
            let content = 
                <h2 class="text-2xl font-bold mb-2">${stock.symbol} ${stock.name}</h2>
                <div class="flex items-center mb-4">
                    <span class="text-3xl font-bold ${changeClass} mr-3">${stock.price}</span>
                    <span class="text-lg ${changeClass}">${changeSymbol} ${Math.abs(parseFloat(stock.change))}%</span>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-2">股價走勢 (30天)</h3>
                    <div class="chart-container bg-white bg-opacity-5 rounded-lg">
                        ${chartPoints.svg}
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white bg-opacity-5 p-3 rounded-lg">
                        <div class="text-sm opacity-70">產業類別</div>
                        <div class="font-medium">${getIndustryName(stock.industry)}</div>
                    </div>
                    <div class="bg-white bg-opacity-5 p-3 rounded-lg">
                        <div class="text-sm opacity-70">投資風格</div>
                        <div class="font-medium">${getStyleName(stock.style)}</div>
                    </div>
                    <div class="bg-white bg-opacity-5 p-3 rounded-lg">
                        <div class="text-sm opacity-70">市值規模</div>
                        <div class="font-medium">${getSizeName(stock.size)}</div>
                    </div>
                    <div class="bg-white bg-opacity-5 p-3 rounded-lg">
                        <div class="text-sm opacity-70">推薦狀態</div>
                        <div class="font-medium">${stock.recommendation ? '推薦買入' : '持平觀望'}</div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-2">分析摘要</h3>
                    <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                        <p>${stock.reason}</p>
                        <p class="mt-2">根據技術分析，該股票目前${parseFloat(stock.change) > 0 ? '呈現上升趨勢，短期有望持續走強' : '呈現下跌趨勢，建議謹慎操作'}。</p>
                    </div>
                </div>
                
                <div class="mb-4 text-xs opacity-70 text-right">
                    數據來源: ${dataSourceText}
                </div>
                
                <div class="flex justify-end">
                    <button id="toggle-watchlist" data-symbol="${symbol}" class="${watchlistBtnClass} text-white font-medium py-2 px-6 rounded-lg transition duration-300 mr-3">
                        ${watchlistBtnText}
                    </button>
                    <button id="close-detail" class="bg-white bg-opacity-10 hover:bg-opacity-20 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                        關閉
                    </button>
                </div>
     
            modalContent.innerHTML = content;
            
            // 添加關閉按鈕事件
            document.getElementById('close-detail').addEventListener('click', closeStockDetailModal);
            
            // 添加追蹤按鈕事件
            document.getElementById('toggle-watchlist').addEventListener('click', toggleWatchlist);
        }
        
        // 關閉股票詳情模態框
        function closeStockDetailModal() {
            document.getElementById('stock-detail-modal').style.display = 'none';
        }
        
        // 切換追蹤清單
        function toggleWatchlist(event) {
            const symbol = event.target.getAttribute('data-symbol');
            const index = watchlist.indexOf(symbol);
            
            if (index === -1) {
                // 添加到追蹤清單
                watchlist.push(symbol);
                showNotification(`已將 ${symbol} 加入追蹤清單`);
                event.target.textContent = '移除追蹤';
                event.target.className = 'bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300 mr-3';
            } else {
                // 從追蹤清單中移除
                watchlist.splice(index, 1);
                showNotification(`已將 ${symbol} 從追蹤清單中移除`);
                event.target.textContent = '加入追蹤';
                event.target.className = 'bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300 mr-3';
            }
            
            // 保存到本地存儲
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
        }
        
        // 生成股價走勢圖
        function generateChartPoints(data) {
            if (!data || data.length === 0) return { svg: '<div class="p-4 text-center">無法獲取股價數據</div>' };
            
            const width = 100;
            const height = 100;
            const padding = 10;
            
            // 找出最高和最低價格
            const prices = data.map(d => d.price);
            const minPrice = Math.min(...prices) * 0.98;
            const maxPrice = Math.max(...prices) * 1.02;
            const priceRange = maxPrice - minPrice;
            
            // 生成SVG路徑
            let pathD = '';
            let areaD = '';
            
            data.forEach((d, i) => {
                const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((d.price - minPrice) / priceRange) * (height - 2 * padding);
                
                if (i === 0) {
                    pathD += `M ${x} ${y}`;
                    areaD += `M ${x} ${height - padding} L ${x} ${y}`;
                } else {
                    pathD += ` L ${x} ${y}`;
                    areaD += ` L ${x} ${y}`;
                }
                
                if (i === data.length - 1) {
                    areaD += ` L ${x} ${height - padding} Z`;
                }
            });
            
            // 生成SVG
            const svg = 
                <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" class="w-full h-full">
                    <path d="${areaD}" class="chart-area"></path>
                    <path d="${pathD}" class="chart-line"></path>
                </svg>
            ;
            
            return { svg };
        }
        
        // 顯示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationContent = document.getElementById('notification-content');
            
            notificationContent.textContent = message;
            
            // 根據類型```